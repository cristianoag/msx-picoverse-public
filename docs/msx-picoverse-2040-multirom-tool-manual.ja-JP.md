# MSX PicoVerse 2040 プロジェクト

|PicoVerse 前面|PicoVerse 背面|
|---|---|
|![PicoVerse 前面](/images/2025-12-02_20-05.png)|![PicoVerse 背面](/images/2025-12-02_20-06.png)|

PicoVerse 2040 は、Raspberry Pi Pico をベースにした MSX 用カートリッジで、交換可能なファームウェアを使用してコンピュータの機能を拡張します。さまざまなファームウェアイメージをロードすることで、カートリッジは MSX のゲームやアプリケーションを実行したり、追加のハードウェアデバイス（ROM マッパー、追加 RAM、ストレージインターフェースなど）をエミュレートしたりすることができ、実質的に MSX に仮想周辺機器を追加します。そのようなファームウェアの 1 つが MultiROM システムで、カートリッジに保存された複数の ROM タイトルを閲覧および起動するための画面上メニューを提供します。

また、カートリッジは Pico の USB-C ポートをマスストレージデバイスとして公開できるため、Windows または Linux を搭載した PC から ROM、DSK、その他のファイルをカートリッジに直接コピーできます。

PicoVerse 2040 カートリッジの現在のバージョンで利用可能な機能は次のとおりです。

* MSX ROM を選択して起動するための MultiROM メメニューシステム。
* Nextor OS サポート付きのインラインメニューオプション。
* ROM および DSK をロードするための USB マスストレージデバイスのサポート。
* さまざまな MSX ROM マッパーのサポート（PL-16, PL-32, KonSCC, Linear, ASC-08, ASC-16, Konami, NEO-8, NEO-16）。
* MSX、MSX2、および MSX2+ システムとの互換性。

## MultiROM UF2 クリエーターマニュアル

このセクションでは、PicoVerse 2040 カートリッジをプログラムする UF2 イメージ（`multirom.uf2`）を生成するために使用される `multirom` コンソールツールについて説明します。

デフォルトの動作では、`multirom` ツールはディレクトリ内の MSX ROM ファイルをスキャンし、それらを Raspberry Pi Pico にフラッシュできる単一の UF2 イメージにパッケージ化します。結果のイメージには通常、Pico ファームウェア、MultiROM MSX メニュー ROM、各 ROM エントリを記述する構成領域、および ROM ペイロード自体が含まれています。

> **注意:** 1 つのイメージに含めることができる ROM は最大 128 個で、合計サイズ制限は約 16 MB です。

提供されるオプションに応じて、`multirom` は MultiROM メニューの代わりにカスタムファームウェアに直接起動する UF2 イメージを生成することもできます。たとえば、Nextor OS を実装するファームウェアを含む UF2 ファイルを生成するためにオプションを使用できます。このモードでは、Pico の USB-C ポートを、Nextor から（たとえば SofaRun 経由で）ROM、DSK、およびその他のファイルをロードするためのマスストレージデバイスとして使用できます。

## 概要

オプションなしで実行された場合、`multirom.exe` ツールは現在の作業ディレクトリで MSX ROM ファイル（`.ROM` または `.rom`）をスキャンし、各 ROM を分析してマッパータイプを推測し、各 ROM を記述する構成テーブル（名前、マッパーバイト、サイズ、オフセット）を作成し、このテーブルを MSX メニュー ROM スライスに埋め込みます。次に、ツールは Pico ファームウェアバイナリ、メニュースライス、構成領域、および ROM ペイロードを連結し、イメージ全体を `multirom.uf2` という名前の UF2 ファイルにシリアル化します。

![alt text](/images/2025-11-29_20-49.png)

UF2 ファイル（通常は multirom.uf2）は、結合されたイメージをフラッシュするために Pico の USB マスストレージデバイスにコピーできます。UF2 フラッシュモードに入るには、BOOTSEL ボタンを押しながら Pico を接続する必要があります。すると、`RPI-RP2` という名前の新しい USB ドライブが表示され、そこに `multirom.uf2` をコピーできます。コピーが完了したら、Pico を取り外してカートリッジを MSX に挿入し、MultiROM メニューを起動できます。

ROM ファイル名は、MSX メニューのエントリ名として使用されます。名前の制限は 50 文字です。MSX メニューで長い名前を表示するためにローリング効果が使用されますが、名前が 50 文字を超えると切り捨てられます。

![alt text](/images/multirom_2040_menu.png)

> **注意:** USB メモリを使用するには、OTG アダプタまたはケーブルが必要になる場合があります。これを使用して、USB-C ポートを標準の USB-A メスポートに変換できます。

> **注意:** `-n` オプションには、特定の MSX2 モデルで動作する実験的な組み込み Nextor ROM が含まれています。このバージョンは異なる通信方法（IO ポートベース）を使用しており、すべてのシステムで動作するとは限りません。

## コマンドラインの使用法

現在は Microsoft Windows 用の実行ファイル（`multirom.exe`）のみが提供されています。

### 基本的な使用法:

```
multirom.exe [オプション]
```

### オプション:
- `-n`, `--nextor` : 構成および出力からベータ版の組み込み NEXTOR ROM を含めます。このオプションはまだ実験的であり、現時点では特定の MSX2 モデルでのみ動作します。
- `-h`, `--help`   : 使用方法のヘルプを表示して終了します。
- `-o <ファイル名>`, `--output <ファイル名>` : UF2 出力ファイル名を設定します（デフォルトは `multirom.uf2`）。
- ROM ファイルに対して特定のマッパータイプを強制する必要がある場合は、ファイル名の `.ROM` 拡張子の前にマッパータグを追加できます。タグは大文字と小文字を区別しません。たとえば、ファイル名を `Knight Mare.PL-32.ROM` とすると、その ROM に対して PL-32 マッパーの使用が強制されます。`SYSTEM` などのタグは無視されます。使用可能なタグのリストは次のとおりです: `PL-16, PL-32, KonSCC, Linear, ASC-08, ASC-16, Konami, NEO-8, NEO-16`

### 例
- 現在のディレクトリにあるすべての `.ROM` ファイルと MultiROM メニューを含む multirom.uf2 ファイルを生成します。コマンドプロンプトを使用するか、実行ファイルをダブルクリックするだけでツールを実行できます。
  ```
  multirom.exe
  ```

## 仕組み（ハイレベル）

1. ツールは現在の作業ディレクトリで `.ROM` または `.rom` で終わるファイルをスキャンします。各ファイルについて：
   - 表示名（拡張子なしのファイル名、50 文字に切り捨て）を抽出します。
   - ファイルサイズを取得し、それが `MIN_ROM_SIZE` と `MAX_ROM_SIZE` の間であることを確認します。
   - `detect_rom_type()` を呼び出して、構成エントリで使用するマッパーバイトをヒューリスティックに決定します。ファイル名にマッパータグが存在する場合、それは検出を上書きします。
   - マッパーの検出に失敗した場合、ファイルはスキップされます。
   - ROM ごとの構成レコード（50 バイトの名前、1 バイトのマッパー、4 バイトのサイズ LE、4 バイトのフラッシュオフセット LE）を構成領域にシリアル化します。
2. スキャン後、ツールは（順番に）組み込み Pico ファームウェアバイナリ、MSX メニュー ROM の先頭スライス（`MENU_COPY_SIZE` バイト）、完全な構成領域（`CONFIG_AREA_SIZE` バイト）、オプションの NEXTOR ROM、そして発見された順序で ROM ペイロードを連結します。
3. 結合されたペイロードは、Pico フラッシュアドレス `0x10000000` をターゲットとした 256 バイトのペイロード UF2 ブロックを生成する `create_uf2_file()` を使用して、`multirom.uf2` という名前の UF2 ファイルとして書き込まれます。

## マッパー検出ヒューリスティック
- `detect_rom_type()` は、シグネチャチェック（"AB" ヘッダー、`ROM_NEO8` / `ROM_NE16` タグ）と、一般的な MSX マッパーを選択するためのオペコードおよびアドレスのヒューリスティックなスキャンの組み合わせを実装しています。これには以下が含まれます（ただしこれらに限定されません）：
  - プレーン 16KB（マッパーバイト 1） — 16KB AB ヘッダーチェック
  - プレーン 32KB（マッパーバイト 2） — 32KB AB ヘッダーチェック
  - Linear0 マッパー（マッパーバイト 4） — 特殊な AB レイアウトチェック
  - NEO8（マッパーバイト 8）および NEO16（マッパーバイト 9）
  - Konami, Konami SCC, ASCII8, ASCII16 など（加重スコアリングによる）
- マッパーを確実に検出できない場合、ツールは ROM をスキップし、「サポートされていないマッパー」と報告します。ファイル名タグを介してマッパーを強制できることを忘れないでください。タグは大文字と小文字を区別せず、以下にリストされています。
- 構成領域とメニューでは、次のマッパーのみがサポートされています: `PL-16, PL-32, KonSCC, Linear, ASC-08, ASC-16, Konami, NEO-8, NEO-16`

## MSX ROM セレクターメニューの使用

PicoVerse 2040 カートリッジを挿入した状態で MSX の電源を入れると、MultiROM メニューが表示され、利用可能な ROM のリストが表示されます。キーボードの矢印キーを使用してメニューを操作できます。

![alt text](/images/multirom_2040_menu.png)

上矢印キーと下矢印キーを使用して、ROM のリスト内で選択カーソルを移動します。19 個以上の ROM がある場合は、左右の矢印キーを使用してエントリのページをスクロールします。

Enter キーまたはスペースキーを押して、選択した ROM を起動します。MSX は適切なマッパー設定を使用して ROM の起動を試みます。

メニューにいる間はいつでも、H キーを押して基本的な手順が記載されたヘルプ画面を表示できます。任意のキーを押すとメインメニューに戻ります。

## PicoVerse 2040 カートリッジでの Nextor の使用

multirom ツールの -n オプションには、特定の MSX2 モデルで使用できる実験的な組み込み Nextor ROM が含まれています。ただし、このオプションはまだ開発中であり、すべてのシステムで動作するとは限りません。このバージョンは MSX と通信するために異なる方法（IO ポートベース）を使用しているため、カートリッジスロットがプライマリではないシステム（スロットエクスパンダを使用している場合など）でも動作します。

MSX コンピュータとの通信に使用されるプロトコルの詳細は、Nextor-Pico-Bridge-Protocol.md ドキュメントに記載されています。

### Nextor 用の USB メモリの準備方法

PicoVerse 2040 カートリッジで Nextor を使用するために USB メモリを準備するには、次の手順に従います。

1. USB メモリを PC に接続します。
2. USB メモリに最大 4GB の FAT16 パーティションを作成します。これを行うには、組み込みの Nextor OS ツール（MSX Basic で CALL FDISK を実行）またはサードパーティのパーティショニングソフトウェアを使用できます。
3. Nextor システムファイルを FAT16 パーティションのルートディレクトリにコピーします。Nextor システムファイルは、公式の Nextor 配布物またはリポジトリから入手できます。コマンドシェルのための COMMAND2 ファイルも必要です。
   1. [Nextor ダウンロードページ](https://github.com/Konamiman/Nextor/releases)
   2. [Command2 ダウンロードページ](http://www.tni.nl/products/command2.html)
4. Nextor で使用する MSX ROM（`.ROM` ファイル）またはディスクイメージ（`.DSK` ファイル）を USB メモリのルートディレクトリにコピーします。
5. ROM や DSK を起動するために使用する予定がある場合は、SofaRun またはその他の Nextor 互換ランチャーを USB メモリにインストールします。SofaRun はこちらの公式サイトからダウンロードできます: [SofaRun](https://www.louthrax.net/mgr/sofarun.html)
6. PC から USB メモリを安全に取り外します。
7. 必要に応じて USB OTG アダプタまたはケーブルを使用して、USB メモリを PicoVerse 2040 カートリッジに接続します。

> **注意:** すべての USB メモリが PicoVerse 2040 カートリッジと互換性があるわけではありません。問題が発生した場合は、別のブランドやモデルの USB メモリを試してください。
>
> **注意:** Nextor の動作には最低 128 KB の RAM が必要であることを忘れないでください。

## 改善のアイデア
- より多くのマッパーやエッジケースをカバーするように ROM タイプ検出ヒューリスティックを改善する。
- 各 ROM エントリの構成画面（名前、マッパーの上書きなど）を実装する。
- より多くの ROM マッパーのサポートを追加する。
- より良いナビゲーションと ROM 情報表示を備えたグラフィカルメニューを実装する。
- ユーザー設定を保存するためのメニュー構成の保存/読み込み機能を追加する。
- 適切な構成エントリを備えた DSK ファイルもサポートする。
- メニューのカスタムテーマのサポートを追加する。
- インターネット URL から ROM をダウンロードして直接埋め込めるようにする。
- ジョイスティックを使用してメニューを操作できるようにする。

## 既知の問題

- 組み込み Nextor ROM の包含はまだ実験的であり、すべての MSX2 モデルで動作するとは限りません。
- 一般的でないマッパーを持つ一部の ROM は正しく検出されない場合があり、有効なマッパータグを使用して強制的に検出させない限りスキップされます。
- MultiROM ツールは現在 Windows のみをサポートしています。Linux および macOS バージョンはまだ利用できません。
- ツールは現在、サイズと基本的なヘッダーチェック以外の ROM ファイルの整合性を検証しません。破損した ROM は予期しない動作を引き起こす可能性があります。
- MultiROM ツールの性質上（複数のファイルを単一の UF2 に埋め込む）、一部のウイルス対策ソフトウェアが実行ファイルを疑わしいものとしてフラグを立てる場合があります。これは誤検知です。信頼できるソースからツールをダウンロードするようにしてください。
- MultiROM メニューは DSK ファイルをサポートしていません。ROM ファイルのみがリストされ、起動されます。
- ツールは現在サブディレクトリをサポートしていません。現在の作業ディレクトリにある ROM ファイルのみが処理されます。
- Pico のフラッシュメモリは、多くの書き込みサイクルの後に摩耗する可能性があります。カートリッジの過度な再フラッシュは避けてください。

## テスト済みの MSX モデル

MultiROM ファームウェアを搭載した PicoVerse 2040 カートリッジは、次の MSX モデルでテストされています。

| モデル | タイプ | ステータス | コメント |
| --- | --- | --- | --- |
| Adermir Carchano Expert 4 | MSX2+ | OK | 動作確認済み |
| Gradiente Expert | MSX1 | OK | 動作確認済み |
| JFF MSX | MSX1 | OK | 動作確認済み |
| MSX Book | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| MSX One | MSX1 | Not OK | カートリッジが認識されない |
| National FS-4500 | MSX1 | OK | 動作確認済み |
| Omega MSX | MSX2+ | OK | 動作確認済み |
| Panasonic FS-A1GT | TurboR | OK | 動作確認済み |
| Panasonic FS-A1ST | TurboR | OK | 動作確認済み |
| Panasonic FS-A1WX | MSX2+ | OK | 動作確認済み |
| Panasonic FS-A1WSX | MSX2+ | OK | 動作確認済み |
| Sharp HotBit HB8000 | MSX1 | OK | 動作確認済み |
| SMX-HB | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| Sony HB-F1XD | MSX2 | OK | 動作確認済み |
| Sony HB-F1XDJ | MSX2 | OK | 動作確認済み |
| Sony HB-F1XV | MSX2+ | OK | 動作確認済み |
| TRHMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| uMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| Yamaha YIS604 | MSX1 | OK | 動作確認済み |

実験的な組み込み Nextor ROM（オプション `-n`）は、次の MSX モデルでテストされています。

| モデル | タイプ | ステータス | コメント |
| --- | --- | --- | --- |
| Omega MSX | MSX2+ | Not OK | USB が検出されない |
| Sony HB-F1XD | MSX2 | Not OK | ディスクセクタの読み取りエラー |
| TRHMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |
| uMSX | MSX2+ (FPGA クローン) | OK | 動作確認済み |

著者: Cristiano Almeida Goncalves
最終更新日: 2025/12/25
